var J=Object.defineProperty;var K=(t,e,a)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var c=(t,e,a)=>(K(t,typeof e!="symbol"?e+"":e,a),a);import"./modulepreload-polyfill-3cfb730f.js";/* empty css             */import{r as Z,i as g,A as ee,T as te,M as ae,S as d,f as N,P as w,a as _,b as x,u as L,F as B,I as re,N as k,C as ne,c as G,d as P,e as se,l as oe,g as ie,h as ce,V as de,G as ue,j as Ee,k as C,m as me,n as he,o as pe}from"./fullscreen-quad-cddcd807.js";import{e as fe,i as Te,R as Re,s as we,a as _e,p as Me,b as be,c as Ae,d as Se,f as De,g as le,h as Fe}from"./prefiltered-env-map-946f44e6.js";import{p as xe}from"./pbr-forward-8429c5c5.js";function Le(t){return[parseInt(t.slice(1,3),16)/255,parseInt(t.slice(3,5),16)/255,parseInt(t.slice(5,7),16)/255]}function ke(t){const a=Math.pow(t[0],2.2),r=Math.pow(t[1],2.2),s=Math.pow(t[2],2.2);return[a,r,s]}class Ie{constructor(){c(this,"nodes");c(this,"cameras");c(this,"drawers");c(this,"materials");this.nodes=[],this.drawers=[],this.cameras=[],this.materials=[]}update(e,a){this.nodes.forEach(r=>r.preUpdate(a)),this.nodes.forEach(r=>r.update(e)),this.cameras.forEach(r=>r.update(e)),this.cameras.sort((r,s)=>r.order-s.order),this.drawers.sort((r,s)=>r.material.queue-s.material.queue)}}function Ue(t,e,a){const r=G(t,e);return new P(t,r,a)}class ye{constructor(e){c(this,"gl");c(this,"scene");c(this,"inputSystem");c(this,"standardVertexModel");c(this,"quadMesh");c(this,"toneMap");c(this,"brdfLutMap");c(this,"whiteTexture");c(this,"framebuffer");c(this,"take");c(this,"callbackId");const a=new de([{name:"POSITION",location:0},{name:"NORMAL",location:1},{name:"TEXCOORD_0",location:3},{name:"TEXCOORD_1",location:4},{name:"TEXCOORD_2",location:5}]),r=C.createQuad("quad"),s=Ue(e,r,a),o=new d(e,e.VERTEX_SHADER,N),i=new d(e,e.FRAGMENT_SHADER,fe),p=new w(e,"exposure",a,o,i),n=new _(p,{name:"toneMap"}),m=new d(e,e.FRAGMENT_SHADER,Te),u=new w(e,"integrateBRDF",a,o,m),M=new _(u),h=new x(e,e.TEXTURE_2D,1,e.RGBA8,32,32),b=new Uint8Array(32*32*4);for(let f=0;f<b.length;++f)b[f]=255;h.bind(e).subImage2D(e.TEXTURE_2D,0,0,0,32,32,e.RGBA,e.UNSIGNED_BYTE,b).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST);const T=new Re(e,{cube:!1,width:256,height:256,colorInternalFormat0:e.RGBA16F});L(T,e,f=>{e.viewport(0,0,T.width,T.height),e.clear(e.COLOR_BUFFER_BIT),M.use(e),s.draw(e,0)});const D=e.drawingBufferWidth,A=e.drawingBufferHeight,E=new x(e,e.TEXTURE_2D,1,e.RGBA16F,D,A);E.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const S=new x(e,e.TEXTURE_2D,1,e.DEPTH_COMPONENT32F,D,A);S.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const l=new B(e,e.FRAMEBUFFER);L(l,e,f=>{f.texture2D(e.COLOR_ATTACHMENT0,e.TEXTURE_2D,E,0).texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,S,0).checkStatus(F=>{if(F!=e.FRAMEBUFFER_COMPLETE)throw new ue(F||e.getError())})}),n.setUniformValues({exposure:1.5,hdrBuffer:E}),this.gl=e,this.scene=new Ie,this.inputSystem=new re,this.take=0,this.standardVertexModel=a,this.quadMesh=s,this.toneMap=n,this.framebuffer=l,this.callbackId=0,this.brdfLutMap=T.colorTextures[0],this.whiteTexture=h}requestRender(){this.callbackId===0&&(this.callbackId=requestAnimationFrame(e=>{this.scene.update(++this.take,0),this.render(),this.callbackId=0}))}render(){const e=this.gl,a=this.scene.drawers;let r=0,s=0;e.clearColor(0,0,0,1),e.clearDepth(1),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.depthFunc(e.LEQUAL);const o=[0];for(let i=1;i<=8;++i)o[i]=0;for(const i of a)o[i.material.queue]++;for(let i=1;i<=8;++i)o[i]+=o[i-1];o.unshift(0),L(this.framebuffer,e,i=>{const{width:p,height:n}=this.framebuffer.size;if(e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r=o[3],s=o[6],r<s)for(const m of this.scene.cameras){const u=m.viewport(p,n).map(Math.round),M=m.prepare(u.aspectRatio);e.viewport(u.x,u.y,u.w,u.h);for(let h=r;h<s;++h)a[h].draw(e,M)}}),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.toneMap.use(e),this.quadMesh.draw(e,0),this.inputSystem.reset()}}function R(t,e){return t.push(e),e}function v(t){return t instanceof Error?t:new Error(String(t))}async function ve(t,e,a){const r=a.scene,s=R(r.nodes,new k(null,"center")),o=R(r.nodes,new k(s,"camera")),i=new he(pe.deg(45),.1,1e3);R(r.cameras,new Ee(o,0,i)),o.trs.translation[2]=3,s.trs.rotation.setEuler([-15,150,0]),s.addComponent(new ne(s,o,a.inputSystem,1,100));const p=G(t,C.createBackdrop("backdrop")),n=new P(t,p,a.standardVertexModel),m=new d(t,t.VERTEX_SHADER,we),u=new d(t,t.FRAGMENT_SHADER,_e),M=new w(t,"skybox",a.standardVertexModel,m,u),h=new _(M,{name:"ocean",queue:5});R(r.drawers,new me(t,n,h)),new d(t,t.VERTEX_SHADER,N);const b=new d(t,t.VERTEX_SHADER,xe),T=new d(t,t.FRAGMENT_SHADER,Me),D=new w(t,"pbr",a.standardVertexModel,b,T),A=R(r.materials,new _(D,{queue:3})),E=new x(t,t.TEXTURE_CUBE_MAP,11,t.SRGB8_ALPHA8,1024,1024),S=await e.loadImageBitmapCube(["/skybox/ocean/right.jpg","/skybox/ocean/left.jpg","/skybox/ocean/top.jpg","/skybox/ocean/bottom.jpg","/skybox/ocean/front.jpg","/skybox/ocean/back.jpg"],{resizeWidth:E.width,resizeHeight:E.height,resizeQuality:"medium"});E.bind(t).subImageCube(0,0,0,t.RGBA,t.UNSIGNED_BYTE,S).parameteri(t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR).parameteri(t.TEXTURE_MAG_FILTER,t.LINEAR).generateMipmap(),S.forEach(Y=>Y.close()),h.setUniformValues({skybox:E});const l=new d(t,t.VERTEX_SHADER,be),f=new d(t,t.FRAGMENT_SHADER,Ae),F=new w(t,"irradiance",a.standardVertexModel,l,f),V=new _(F,{uniforms:{envMap:E}}),I=new B(t,t.FRAMEBUFFER),X=Se(t,128,V,a.quadMesh,I),q=new d(t,t.VERTEX_SHADER,De),O=new d(t,t.FRAGMENT_SHADER,le),H=new w(t,"prefiltered",a.standardVertexModel,q,O),j=new _(H,{uniforms:{envMap:E}}),U=6,W=Fe(t,U,3,j,a.quadMesh,I);A.setUniformValues({baseColorMap:a.whiteTexture,brdfLutMap:a.brdfLutMap,irradianceEnvMap:X,maxLevel:U,prefilteredEnvMap:W,metallicRoughnessMap:a.whiteTexture,occlusionMap:a.whiteTexture});const y=R(r.nodes,new k(null,"sphere"));y.trs.translation=se(-.2,-.8,0);const z=new URL("/Duck/Duck.gltf",window.location.toString()),$=await e.loadGltf(z.href),Q=new Ne(t,a.scene,y,t.STATIC_DRAW,A);oe($,Q)}class Ne extends ie{constructor(a,r,s,o,i){super(a,i.program,s,o);c(this,"scene");c(this,"standardMaterial");this.scene=r,this.standardMaterial=i}finish(){this.scene.nodes=this.scene.nodes.concat(this.nodes),super.finish()}linkNodeMesh(a,r,s,o){super.linkNodeMesh(a,r,s,o),this.scene.drawers.push(new ce(this.gl,this.nodes[a],this.meshes[r],this.standardMaterial))}}function Be(t){switch(t){case"range":return Number;case"color":return e=>ke(Le(e));default:return e=>0}}try{const t=document.querySelector("main canvas");if(!t)throw new Error("cannot find the canvas");Z(t,1024);const e=g(t),a=Array.from(document.querySelectorAll(".inspector input")),r=new ee,s=new ye(e),o=new te(n=>{switch(n.touchDrags.length){case 1:s.inputSystem.drag(n.touchDrags[0].delta[0],n.touchDrags[0].delta[1]);break}s.requestRender()}),i=new ae(n=>{s.inputSystem.drag(n.delta[0],n.delta[1]),s.requestRender()});t.addEventListener("mousedown",n=>i.mouseDown(n)),document.addEventListener("mousemove",n=>i.mouseMove(n)),document.addEventListener("mouseup",n=>i.mouseUp(n)),t.addEventListener("touchstart",n=>o.touchStart(n)),document.addEventListener("touchend",n=>o.touchEnd(n)),document.addEventListener("touchmove",n=>o.touchMove(n)),ve(e,r,s).then(()=>{s.requestRender()}).catch(n=>{console.error(v(n))});const p=s.scene.materials.find(n=>n.name==="pbr");for(const n of a){const m=Be(n.type);n.addEventListener("input",u=>{p.setUniformValues({[n.id]:m(n.value)}),s.requestRender()}),p.setUniformValues({[n.id]:m(n.value)})}s.requestRender()}catch(t){const e=document.body,a=v(t).message,r=document.createElement("p");r.classList.add("error"),r.append(a),e.prepend(r)}
