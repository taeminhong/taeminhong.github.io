var se=Object.defineProperty;var re=(n,e,t)=>e in n?se(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>(re(n,typeof e!="symbol"?e+"":e,t),t);import"./modulepreload-polyfill-3cfb730f.js";/* empty css             */import{r as oe,i as ie,A as ce,T as de,s as F,p as G,M as ue,F as H,b as N,u as k,S as y,f as q,P as w,a as b,I as me,N as B,C as le,c as W,d as J,v as I,q as L,m as he,O as fe,l as pe,Q as z,g as Ee,h as X,R as Me,V as Te,k as P,G as we,j as _e,n as be,o as Re}from"./fullscreen-quad-cddcd807.js";import{e as ve,i as Se,R as Ae,d as ye,f as xe,g as De,h as Fe,s as Ie,a as Le,p as Ne,b as ke,c as Be}from"./prefiltered-env-map-946f44e6.js";import{p as Pe}from"./pbr-forward-depth-peel-d5c5426d.js";var Oe=`#version 300 es

#define MAX_JOINTS 64

in vec4 POSITION;
in vec2 TEXCOORD_0;
in vec3 NORMAL;
#ifdef MAX_JOINTS
in uvec4 JOINTS_0;
in vec4 WEIGHTS_0;
#endif

out vec3 v_position;
out vec2 v_texCoord;
out vec3 v_normal;

uniform mat4 model;
uniform mat4 view;
uniform mat4 proj;

#ifdef MAX_JOINTS
uniform mat4 jointMatrices[MAX_JOINTS];
uniform mat4 inverseBindMatrices[MAX_JOINTS];
uniform float rigging;
#endif

void main()
{
#ifdef MAX_JOINTS
    mat4 m = mat4(0);
    for (int i = 0; i < 4; ++i) {
        m += WEIGHTS_0[i] * jointMatrices[JOINTS_0[i]] * inverseBindMatrices[JOINTS_0[i]];
    }
    m = (1.0 - rigging) * model + rigging * m;
#else
    mat4 m = model;
#endif
    mat4 mv = view * m;
    mat4 mvp = proj * mv;
    v_texCoord = TEXCOORD_0;
    v_normal = mat3(view) * inverse(transpose(mat3(m))) * NORMAL;
    v_position = (mv * POSITION).xyz;
    gl_Position = mvp * POSITION;
}`;function Ce(n,e){const t=n.queue*2+(n.doubleSided?1:0),a=e.queue*2+(e.doubleSided?1:0);return t-a}class Ue{constructor(){d(this,"nodes");d(this,"cameras");d(this,"drawers");d(this,"materials");d(this,"indirectLightMaterial");this.nodes=[],this.drawers=[],this.cameras=[],this.materials=[]}update(e,t){this.nodes.forEach(a=>a.preUpdate(t)),this.nodes.forEach(a=>a.update(e)),this.nodes.forEach(a=>a.postUpdate()),this.cameras.forEach(a=>a.update(e)),this.cameras.sort((a,r)=>a.order-r.order),this.drawers.sort((a,r)=>Ce(a.material,r.material))}}function j(n,e,t){const a=W(n,e);return new J(n,a,t)}class ge{constructor(e){d(this,"gl");d(this,"scene");d(this,"inputSystem");d(this,"standardVertexModel");d(this,"quadMesh");d(this,"jointMesh");d(this,"toneMap");d(this,"brdfLutMap");d(this,"whiteTexture");d(this,"framebufferWidth");d(this,"framebufferHeight");d(this,"framebuffer");d(this,"take");d(this,"callbackId");const t=new Te([{name:"POSITION",location:0},{name:"NORMAL",location:1},{name:"TEXCOORD_0",location:3},{name:"TEXCOORD_1",location:4},{name:"TEXCOORD_2",location:5},{name:"JOINTS_0",location:6,type:"uvec4",default:[0,0,0,0]},{name:"WEIGHTS_0",location:7}]),a=P.createQuad("quad"),r=j(e,a,t),o=j(e,P.createSphere("joint",2,2,2),t),i=new H(e,e.FRAMEBUFFER),c=e.drawingBufferWidth,s=e.drawingBufferHeight,u=new N(e,e.TEXTURE_2D,1,e.RGBA16F,c,s);u.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const m=new N(e,e.TEXTURE_2D,1,e.DEPTH_COMPONENT32F,c,s);m.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind(),k(i,e,E=>{E.texture2D(e.COLOR_ATTACHMENT0,e.TEXTURE_2D,u,0).texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,m,0).checkStatus(S=>{if(S!=e.FRAMEBUFFER_COMPLETE)throw new we(S||e.getError())})});const l=new y(e,e.VERTEX_SHADER,q),h=new y(e,e.FRAGMENT_SHADER,ve),M=new w(e,"exposure",t,l,h),f=new b(M,{name:"toneMap"}),R=new y(e,e.FRAGMENT_SHADER,Se),T=new w(e,"integrateBRDF",t,l,R),p=new b(T),x=new N(e,e.TEXTURE_2D,1,e.RGBA8,32,32),v=new Uint8Array(32*32*4);for(let E=0;E<v.length;++E)v[E]=255;x.bind(e).subImage2D(e.TEXTURE_2D,0,0,0,32,32,e.RGBA,e.UNSIGNED_BYTE,v).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST),f.setUniformValues({exposure:1.5,hdrBuffer:u});const _=new Ae(e,{cube:!1,width:256,height:256,colorInternalFormat0:e.RGBA16F});k(_,e,E=>{e.viewport(0,0,_.width,_.height),e.clear(e.COLOR_BUFFER_BIT),p.use(e),r.draw(e,0)}),this.gl=e,this.scene=new Ue,this.inputSystem=new me,this.take=0,this.standardVertexModel=t,this.quadMesh=r,this.jointMesh=o,this.toneMap=f,this.framebufferWidth=c,this.framebufferHeight=s,this.framebuffer=i,this.callbackId=0,this.brdfLutMap=_.colorTextures[0],this.whiteTexture=x}render(){const e=this.gl,t=this.scene.drawers,a=(o,i,c)=>{const s=o.viewport(this.framebufferWidth,this.framebufferHeight).map(Math.round),u=o.prepare(s.aspectRatio);e.viewport(s.x,s.y,s.w,s.h);for(let m=i;m<c;++m)if(t[m].layer&o.cullMask){const l=t[m].material;l.setUniformValues({flipNormal:!1},!0),t[m].draw(e,u),l.doubleSided&&(e.cullFace(e.FRONT),l.setUniformValues({flipNormal:!0},!0),t[m].draw(e,u),e.cullFace(e.BACK))}};e.clearColor(0,0,0,1),e.clearDepth(1),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK);const r=[];for(let o=0;o<10;++o)r[o]=0;for(const o of t)r[o.material.queue]++;for(let o=1;o<r.length;++o)r[o]+=r[o-1];r.unshift(0),console.assert(r[10]===t.length),k(this.framebuffer,e,o=>{e.clearBufferfv(e.COLOR,0,[.05,.05,.05,1]),e.clearBufferfv(e.DEPTH,0,[1]);let i=r[3],c=r[4];if(i<c)for(const s of this.scene.cameras)a(s,i,c);i=r[4],c=r[5];for(const s of this.scene.cameras)a(s,i,c);if(i=r[7],c=r[8],i<c){e.disable(e.DEPTH_TEST);for(const s of this.scene.cameras)a(s,i,c);e.enable(e.DEPTH_TEST)}}),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.toneMap.use(e),this.quadMesh.draw(e,0),this.inputSystem.reset()}}function A(n,e){return n.push(e),e}function V(n){return n instanceof Error?n:new Error(String(n))}async function Ge(n,e,t){const a=t.scene,r=A(a.nodes,new B(null,"center"));r.trs.rotation.setEuler([0,180,0]);const o=A(a.nodes,new B(r,"camera"));o.trs.translation[2]=2,r.addComponent(new le(r,o,t.inputSystem,1,5));const i=new be(Re.deg(45),.1,1e3);A(a.cameras,new _e(o,0,i));const c=W(n,P.createBackdrop("backdrop"));new J(n,c,t.standardVertexModel);const s=I(n,Ie),u=L(n,Le),m=new w(n,"skybox",t.standardVertexModel,s,u),l=new b(m,{name:"ocean",queue:4});I(n,q);const h=I(n,Oe),M=L(n,Ne),f=L(n,Pe),R=new w(n,"pbr",t.standardVertexModel,h,M);new w(n,"pbrDepthPeeling",t.standardVertexModel,h,f);const T=await e.loadImageBitmapCube(["/skybox/ocean/right.jpg","/skybox/ocean/left.jpg","/skybox/ocean/top.jpg","/skybox/ocean/bottom.jpg","/skybox/ocean/front.jpg","/skybox/ocean/back.jpg"]),p=new N(n,n.TEXTURE_CUBE_MAP,11,n.SRGB8_ALPHA8,1024,1024);p.bind(n).subImageCube(0,0,0,n.RGBA,n.UNSIGNED_BYTE,T).parameteri(n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR).parameteri(n.TEXTURE_MAG_FILTER,n.LINEAR).generateMipmap(),T.forEach(ae=>ae.close()),l.setUniformValues({skybox:p});const x=I(n,ke),v=L(n,Be),_=new w(n,"irradiance",t.standardVertexModel,x,v),E=new b(_,{uniforms:{envMap:p}}),S=new H(n,n.FRAMEBUFFER),O=ye(n,128,E,t.quadMesh,S),Q=new y(n,n.VERTEX_SHADER,xe),$=new y(n,n.FRAGMENT_SHADER,De),Y=new w(n,"prefiltered",t.standardVertexModel,Q,$),K=new b(Y,{uniforms:{envMap:p}}),C=6,Z=Fe(n,C,3,K,t.quadMesh,S);l.setUniformValues({skybox:O,offset:[0,0,1]}),a.drawers.push(new he(n,t.quadMesh,l));const U=A(a.materials,new b(R,{name:"standard",queue:3,quiet:!0,uniforms:{baseColorMap:t.whiteTexture,brdfLutMap:t.brdfLutMap,irradianceEnvMap:O,maxLevel:C,prefilteredEnvMap:Z,baseColorValue:[0,0,0,1],occulsionFactor:1,roughnessFactor:.5,metallicFactor:0,metallicRoughnessMap:t.whiteTexture,occlusionMap:t.whiteTexture}})),g=U.clone();g.queue=7,g.setUniformValues({baseColorValue:[0,1,.5,1]});const D=A(a.nodes,new B(null,"gltf"));D.trs.rotation.setEuler([0,180,0]),fe(D.trs.translation,0,-.8,0);const ee=new URL("/zombie_hazmat/scene.gltf",window.location.toString()),te=await e.loadGltf(ee.href,!0),ne=new je(t,D,U);return pe(te,ne),{animator:D.components.find(Xe)}}function Xe(n){return n instanceof z}class je extends Ee{constructor(t,a,r,o,i){super(t.gl,r.program,a,t.gl.STATIC_DRAW);d(this,"scene");d(this,"standardMaterial");d(this,"jointMesh");d(this,"jointMaterial");this.scene=t.scene,this.standardMaterial=r,this.jointMesh=o,this.jointMaterial=i}finish(){this.scene.nodes=this.scene.nodes.concat(this.nodes);const t=new z(this.animations);this.root.addComponent(t),this.scene.materials=this.scene.materials.concat(this.ourMaterials),super.finish()}addMaterial(t){const a=super.addMaterial(t),r=this.ourMaterials[a];return r.doubleSided=!!t.doubleSided,a}addSkin(t,a,r){const o=super.addSkin(t,a,r);if(this.jointMesh&&this.jointMaterial)for(const i of this.skins[o].joints)i!==this.skins[o].skeleton&&this.scene.drawers.push(new X(this.gl,i,this.jointMesh,this.jointMaterial));return o}createMaterial(){return this.standardMaterial.clone()}linkNodeMesh(t,a,r,o){super.linkNodeMesh(t,a,r,o);let i;if(r!==void 0?i=this.ourMaterials[r]:i=this.standardMaterial.clone(),o!==void 0){const c=new Me(this.gl,this.nodes[t],this.meshes[a],i,this.skins[o]);this.scene.drawers.push(c);const s=this.skins[o].inverseBindMatrices;i.setUniformValues({inverseBindMatrices:s,rigging:1},!0)}else{const c=new X(this.gl,this.nodes[t],this.meshes[a],i);this.scene.drawers.push(c)}}}class Ve{constructor(e,t){d(this,"dropdown");d(this,"playButton");d(this,"slider");d(this,"dragging");d(this,"resume");d(this,"onClickPlayButton");const a=this,r=document.createElement("select"),o=document.createElement("button"),i=document.createElement("img"),c=document.createElement("input");c.type="range",c.min="0",c.max="1",c.step="0.001";function s(){t.state==="play"?t.pause():t.play(),i.src=t.state==="play"?"/pause.svg":"/play.svg"}c.addEventListener("change",u=>{a.resume&&t.play(),a.dragging=!1,a.resume=!1}),c.addEventListener("input",u=>{var l;!a.dragging&&t.state==="play"&&(a.resume=!0,t.pause()),a.dragging=!0;const m=(l=t.currentAnimation)==null?void 0:l.timeLength;m!==void 0&&(t.time=Number(this.slider.value)*m)}),i.src=t.state==="play"?"/pause.svg":"/play.svg",o.addEventListener("click",s),o.append(i),e.append(o,c,r);for(const u of t.animations)r.add(new Option(u.name,u.name));r.addEventListener("change",function(u){this.selectedIndex!==-1&&(t.selectAnimation(this.selectedIndex),a.slider.value=String(t.time))}),r.selectedIndex=0,t.selectAnimation(0),this.dropdown=r,this.playButton=o,this.slider=c,this.onClickPlayButton=s,this.dragging=!1,this.resume=!1}clickPlayButton(){this.onClickPlayButton.call(this.playButton)}updateSlider(e,t){if(this.dragging)return;const a=e%t/t,r=Number(this.slider.step);this.slider.value=String(Math.round(a/r)*r)}}try{let n=function(s){s.preventDefault(),o.inputSystem.scroll(s.deltaY)};const e=document.querySelector("main canvas"),t=document.querySelector("main .animation-controller");if(!e)throw new Error("cannot find the canvas");if(!t)throw new Error("cannot find the controller");oe(e,1024);const a=ie(e),r=new ce,o=new ge(a),i=new de(s=>{switch(s.touchDrags.length){case 1:{const u=s.touchDrags[0];o.inputSystem.drag(u.delta[0],u.delta[1]);break}case 2:{const u=s.touchDrags[0],m=s.touchDrags[1],l=F(u.currentPos,u.delta),h=F(m.currentPos,m.delta),M=G(F(l,h)),f=G(F(u.currentPos,m.currentPos));o.inputSystem.scroll(M-f);break}}}),c=new ue(s=>{o.inputSystem.drag(s.delta[0],s.delta[1])});e.addEventListener("wheel",n,{passive:!1}),e.addEventListener("mousedown",s=>c.mouseDown(s)),document.addEventListener("mousemove",s=>c.mouseMove(s)),document.addEventListener("mouseup",s=>c.mouseUp(s)),e.addEventListener("touchstart",s=>i.touchStart(s)),document.addEventListener("touchend",s=>i.touchEnd(s)),document.addEventListener("touchmove",s=>i.touchMove(s)),async function(){try{let s=function(f){var T;f/=1e3;const R=h?f-h:0;if(h=f,o.scene.update(++M,R),o.render(),l.state==="play"){const p=((T=l.currentAnimation)==null?void 0:T.timeLength)||1;m.updateSlider(l.time,p)}requestAnimationFrame(s)};const u=await Ge(a,r,o),m=new Ve(t,u.animator),l=u.animator;m.clickPlayButton();let h,M=0;requestAnimationFrame(s)}catch(s){console.error(V(s))}}()}catch(n){const e=document.body,t=V(n).message,a=document.createElement("pre");a.classList.add("error"),a.append(t),e.prepend(a)}
