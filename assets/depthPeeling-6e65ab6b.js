var de=Object.defineProperty;var ue=(a,e,r)=>e in a?de(a,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[e]=r;var i=(a,e,r)=>(ue(a,typeof e!="symbol"?e+"":e,r),r);import"./modulepreload-polyfill-3cfb730f.js";/* empty css             */import{r as he,i as fe,A as Ee,T as pe,s as B,p as V,M as me,F as I,b as M,u as w,S as v,f as $,P as p,a as m,q as x,I as le,N as O,C as Te,c as z,d as g,v as L,e as _e,l as Re,g as be,h as q,G as Q,V as we,j as W,k as Y,n as Me,o as Ae}from"./fullscreen-quad-cddcd807.js";import{e as Pe,i as De,R as xe,d as ve,f as Se,g as Fe,h as Be,s as Le,a as ye,p as Ce,b as Ue,c as Ne}from"./prefiltered-env-map-946f44e6.js";import{p as ke}from"./pbr-forward-8429c5c5.js";import{p as Oe}from"./pbr-forward-depth-peel-d5c5426d.js";var Ie=`#version 300 es

precision highp float;

in vec2 v_texCoord;

out vec4 f_color;

uniform sampler2D layer0;
uniform sampler2D layer1;
uniform sampler2D layer2;
uniform sampler2D layer3;

vec4 blendBackward(vec4 front, vec4 back)
{
    return vec4(
        front.rgb + front.a * back.a * back.rgb,
        front.a * (1.0 - back.a)
    );
}

void main()
{
    vec4 color0 = texture(layer0, v_texCoord);
    vec4 color1 = texture(layer1, v_texCoord);
    vec4 color2 = texture(layer2, v_texCoord);
    vec4 color3 = texture(layer3, v_texCoord);

    vec4 merge = blendBackward(vec4(0, 0, 0, 1), color0);
    merge = blendBackward(merge, color1);
    merge = blendBackward(merge, color2);
    merge = blendBackward(merge, color3);

    f_color = merge;
}`;class Xe{constructor(){i(this,"nodes");i(this,"cameras");i(this,"drawers");i(this,"materials");i(this,"indirectLightMaterial");this.nodes=[],this.drawers=[],this.cameras=[],this.materials=[]}update(e,r){this.nodes.forEach(s=>s.preUpdate(r)),this.nodes.forEach(s=>s.update(e)),this.cameras.forEach(s=>s.update(e)),this.cameras.sort((s,n)=>s.order-n.order),this.drawers.sort((s,n)=>s.material.queue-n.material.queue)}}function Ge(a,e,r){const s=z(a,e);return new g(a,s,r)}class He{constructor(e,r,s,n){i(this,"binder");i(this,"colorBuffers");i(this,"depthBuffers");const c=r.bind(e);c.texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,n[1],0),e.clearBufferfv(e.DEPTH,0,[0]),this.binder=c,this.colorBuffers=s,this.depthBuffers=n}unbind(){this.binder.unbind()}layer(e){if(e<0||e>=this.colorBuffers.length)throw new RangeError(`invalid layer index [0, ${this.colorBuffers.length}): ${e}`);const r=this.binder.gl;return this.binder.texture2D(r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.colorBuffers[e],0).texture2D(r.DEPTH_ATTACHMENT,r.TEXTURE_2D,this.depthBuffers[e%2],0),this.depthBuffers[(e+1)%2]}}class Ve{constructor(e,r,s,n,c){i(this,"width");i(this,"height");i(this,"framebuffer");i(this,"colorBuffers");i(this,"depthBuffers");i(this,"material");if(r<1)throw new RangeError(`There must be at least one layer in DepthPeeler, but given ${r}`);const o=[];for(let d=0;d<2;++d){const h=new M(e,e.TEXTURE_2D,1,e.DEPTH_COMPONENT32F,s,n);h.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind(),o.push(h)}const t=[];for(let d=0;d<r;++d){const h=new M(e,e.TEXTURE_2D,1,e.RGBA8,s,n);h.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind(),t.push(h)}const u=new I(e,e.FRAMEBUFFER);w(u,e,d=>{d.texture2D(e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t[0],0).texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o[0],0).drawBuffers(e.COLOR_ATTACHMENT0).checkStatus(h=>{if(h!=e.FRAMEBUFFER_COMPLETE)throw new Q(h||e.getError())})}),c.setUniformValues({layer0:t[0],layer1:t[1],layer2:t[2],layer3:t[3]}),this.framebuffer=u,this.depthBuffers=o,this.colorBuffers=t,this.width=s,this.height=n,this.material=c}bind(e){return new He(e,this.framebuffer,this.colorBuffers,this.depthBuffers)}blend(e,r){this.material.use(e),r.draw(e,0)}get length(){return this.colorBuffers.length}}class qe{constructor(e){i(this,"gl");i(this,"scene");i(this,"inputSystem");i(this,"standardVertexModel");i(this,"quadMesh");i(this,"toneMap");i(this,"brdfLutMap");i(this,"whiteTexture");i(this,"framebufferWidth");i(this,"framebufferHeight");i(this,"depthPeeler");i(this,"framebuffer");i(this,"take");i(this,"callbackId");const r=new we([{name:"POSITION",location:0},{name:"NORMAL",location:1},{name:"TEXCOORD_0",location:3},{name:"TEXCOORD_1",location:4},{name:"TEXCOORD_2",location:5}]),s=Y.createQuad("quad"),n=Ge(e,s,r),c=new I(e,e.FRAMEBUFFER),o=e.drawingBufferWidth,t=e.drawingBufferHeight,u=new M(e,e.TEXTURE_2D,1,e.RGBA16F,o,t);u.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const d=new M(e,e.TEXTURE_2D,1,e.DEPTH_COMPONENT32F,o,t);d.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind(),w(c,e,E=>{E.texture2D(e.COLOR_ATTACHMENT0,e.TEXTURE_2D,u,0).texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,d,0).checkStatus(P=>{if(P!=e.FRAMEBUFFER_COMPLETE)throw new Q(P||e.getError())})});const h=new v(e,e.VERTEX_SHADER,$),l=new v(e,e.FRAGMENT_SHADER,Pe),f=new p(e,"exposure",r,h,l),R=new m(f,{name:"toneMap"}),S=new v(e,e.FRAGMENT_SHADER,De),y=new p(e,"integrateBRDF",r,h,S),C=new m(y),F=new M(e,e.TEXTURE_2D,1,e.RGBA8,32,32),A=new Uint8Array(32*32*4);for(let E=0;E<A.length;++E)A[E]=255;F.bind(e).subImage2D(e.TEXTURE_2D,0,0,0,32,32,e.RGBA,e.UNSIGNED_BYTE,A).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST),R.setUniformValues({exposure:1.5,hdrBuffer:u});const T=new xe(e,{cube:!1,width:256,height:256,colorInternalFormat0:e.RGBA16F});w(T,e,E=>{e.viewport(0,0,T.width,T.height),e.clear(e.COLOR_BUFFER_BIT),C.use(e),n.draw(e,0)});const b=x(e,Ie),U=new p(e,"merge",r,h,b),N=new m(U),k=new Ve(e,4,o,t,N);this.gl=e,this.scene=new Xe,this.inputSystem=new le,this.take=0,this.standardVertexModel=r,this.quadMesh=n,this.toneMap=R,this.framebufferWidth=o,this.framebufferHeight=t,this.framebuffer=c,this.callbackId=0,this.brdfLutMap=T.colorTextures[0],this.whiteTexture=F,this.depthPeeler=k}requestRender(){this.callbackId===0&&(this.callbackId=requestAnimationFrame(e=>{this.scene.update(++this.take,0),this.render(),this.callbackId=0}))}render(){const e=this.gl,r=this.scene.drawers;let s=0,n=0;e.clearColor(0,0,0,1),e.clearDepth(1),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),w(this.framebuffer,e,c=>{s=D(r,n,o=>o.material.queue>=3,r.length),n=D(r,s,o=>o.material.queue>5,r.length),e.clearBufferfv(e.COLOR,0,[.05,.05,.05,1]),e.clearBufferfv(e.DEPTH,0,[1]);for(const o of this.scene.cameras){const t=o.viewport(this.framebufferWidth,this.framebufferHeight).map(Math.round),u=o.prepare(t.aspectRatio);e.viewport(t.x,t.y,t.w,t.h);for(let d=s;d<n;++d)r[d].layer&o.cullMask&&r[d].draw(e,u)}if(s=n,n=D(r,s,o=>o.material.queue>6,r.length),n>s){e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.enable(e.BLEND);for(const o of this.scene.cameras){const t=o.viewport(this.framebufferWidth,this.framebufferHeight).map(Math.round),u=o.prepare(t.aspectRatio);e.viewport(t.x,t.y,t.w,t.h);for(let d=s;d<n;++d)r[d].layer&o.cullMask&&r[d].draw(e,u)}e.disable(e.BLEND)}}),s=D(r,n,c=>c.material.queue===7,r.length),n=D(r,s,c=>c.material.queue>7,r.length),s<n&&(w(this.depthPeeler,e,c=>{for(let o=0;o<this.depthPeeler.length;++o){const t=c.layer(o),u=[this.depthPeeler.width,this.depthPeeler.height];e.clearBufferfv(e.COLOR,0,[0,0,0,0]),e.clearBufferfv(e.DEPTH,0,[1]);for(const d of this.scene.cameras){const h=d.viewport(this.depthPeeler.width,this.depthPeeler.height).map(Math.round),l=d.prepare(h.aspectRatio);e.viewport(h.x,h.y,h.w,h.h);for(let f=s;f<n;++f)r[f].layer&d.cullMask&&(r[f].material.setUniformValues({depthPeelReference:t,depthPeelScreenSize:u,depthBias:1e-4},!0),r[f].draw(e,l),r[f].material.setUniformValues({depthPeelReference:null},!0))}}}),w(this.framebuffer,e,c=>{e.viewport(0,0,this.framebufferWidth,this.framebufferHeight),e.disable(e.DEPTH_TEST),e.blendFuncSeparate(e.ONE,e.SRC_ALPHA,e.ZERO,e.ONE),e.enable(e.BLEND),this.depthPeeler.blend(e,this.quadMesh),e.disable(e.BLEND),e.enable(e.DEPTH_TEST)})),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.toneMap.use(e),this.quadMesh.draw(e,0),this.inputSystem.reset()}}function D(a,e,r,s=-1){for(let n=e;n<a.length;++n)if(r(a[n],n,a))return n;return s}function _(a,e){return a.push(e),e}function j(a){return a instanceof Error?a:new Error(String(a))}async function We(a,e,r){const s=r.scene,n=_(s.nodes,new O(null,"center")),c=_(s.nodes,new O(n,"camera"));c.trs.translation[2]=3,n.addComponent(new Te(n,c,r.inputSystem,1,5));const o=new Me(Ae.deg(45),.1,1e3),t=_(s.cameras,new W(c,0,o));t.normalizedViewportRect.w=.5,t.cullMask^=4;const u=_(s.cameras,new W(c,0,o));u.normalizedViewportRect.w=.5,u.normalizedViewportRect.x=.5,u.cullMask^=2;const d=z(a,Y.createBackdrop("backdrop"));new g(a,d,r.standardVertexModel);const h=L(a,Le),l=x(a,ye),f=new p(a,"skybox",r.standardVertexModel,h,l),R=new m(f,{name:"ocean",queue:5});L(a,$);const S=L(a,ke),y=x(a,Ce),C=x(a,Oe),F=new p(a,"pbr",r.standardVertexModel,S,y),A=new p(a,"pbrDepthPeeling",r.standardVertexModel,S,C),T=await e.loadImageBitmapCube(["/skybox/ocean/right.jpg","/skybox/ocean/left.jpg","/skybox/ocean/top.jpg","/skybox/ocean/bottom.jpg","/skybox/ocean/front.jpg","/skybox/ocean/back.jpg"]),b=new M(a,a.TEXTURE_CUBE_MAP,11,a.SRGB8_ALPHA8,1024,1024);b.bind(a).subImageCube(0,0,0,a.RGBA,a.UNSIGNED_BYTE,T).parameteri(a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR).parameteri(a.TEXTURE_MAG_FILTER,a.LINEAR).generateMipmap(),T.forEach(ce=>ce.close()),R.setUniformValues({skybox:b});const U=L(a,Ue),N=x(a,Ne),k=new p(a,"irradiance",r.standardVertexModel,U,N),E=new m(k,{uniforms:{envMap:b}}),P=new I(a,a.FRAMEBUFFER),Z=ve(a,128,E,r.quadMesh,P),K=new v(a,a.VERTEX_SHADER,Se),J=new v(a,a.FRAGMENT_SHADER,Fe),ee=new p(a,"prefiltered",r.standardVertexModel,K,J),re=new m(ee,{uniforms:{envMap:b}}),X=6,te=Be(a,X,3,re,r.quadMesh,P),G={baseColorMap:r.whiteTexture,brdfLutMap:r.brdfLutMap,irradianceEnvMap:Z,maxLevel:X,prefilteredEnvMap:te,baseColorValue:[0,0,0,1],metallicRoughnessMap:r.whiteTexture},ae=_(s.materials,new m(F,{name:"standard",queue:6,quiet:!0,uniforms:G})),se=_(s.materials,new m(A,{name:"depthPeeling",queue:7,quiet:!0,uniforms:G})),H=_(s.nodes,new O(null,"sphere"));H.trs.scale=_e(20,20,20);const ne=new URL("/ToyCar/ToyCar.gltf",window.location.toString()),oe=await e.loadGltf(ne.href),ie=new je(r,H,a.STATIC_DRAW,ae,se);Re(oe,ie)}class je extends be{constructor(r,s,n,c,o){super(r.gl,c.program,s,n);i(this,"renderer");i(this,"materialMap");i(this,"standardMaterial");i(this,"usage");i(this,"root");const t=new Map;t.set("transparentFabric",c.clone({uniforms:{roughnessFactor:1,baseColorValue:[1,0,0,.7]}})),t.set("transparentToyCar",c.clone({uniforms:{roughnessFactor:0,baseColorValue:[0,1,0,.5]}})),t.set("transparentGlass",c.clone({uniforms:{roughnessFactor:0,baseColorValue:[0,0,1,.3]}})),t.set("depthPeelingFabric",o.clone({uniforms:{roughnessFactor:1,baseColorValue:[1,0,0,.7]}})),t.set("depthPeelingToyCar",o.clone({uniforms:{roughnessFactor:0,baseColorValue:[0,1,0,.5]}})),t.set("depthPeelingGlass",o.clone({uniforms:{roughnessFactor:0,baseColorValue:[0,0,1,.3]}}));for(const u of t.values())r.scene.materials.push(u);this.renderer=r,this.standardMaterial=c,this.materialMap=t,this.root=s,this.usage=n}finish(){this.renderer.scene.nodes=this.renderer.scene.nodes.concat(this.nodes),super.finish()}linkNodeMesh(r,s,n,c){super.linkNodeMesh(r,s,n,c);const o=this.renderer.gl,t=this.renderer.scene.drawers,u=this.meshes[s].geometry.name,d=this.materialMap.get("transparent"+u)??this.standardMaterial,h=this.materialMap.get("depthPeeling"+u)??this.standardMaterial;t.push(new q(o,this.nodes[r],this.meshes[s],d,2)),t.push(new q(o,this.nodes[r],this.meshes[s],h,4))}}try{let a=function(t){t.preventDefault(),n.inputSystem.scroll(t.deltaY),n.requestRender()};const e=document.querySelector("main canvas");if(!e)throw new Error("cannot find the canvas");he(e,1024);const r=fe(e),s=new Ee,n=new qe(r),c=new pe(t=>{switch(t.touchDrags.length){case 1:{const u=t.touchDrags[0];n.inputSystem.drag(u.delta[0],u.delta[1]);break}case 2:{const u=t.touchDrags[0],d=t.touchDrags[1],h=B(u.currentPos,u.delta),l=B(d.currentPos,d.delta),f=V(B(h,l)),R=V(B(u.currentPos,d.currentPos));n.inputSystem.scroll(f-R);break}}n.requestRender()}),o=new me(t=>{n.inputSystem.drag(t.delta[0],t.delta[1]),n.requestRender()});e.addEventListener("wheel",a,{passive:!1}),e.addEventListener("mousedown",t=>o.mouseDown(t)),document.addEventListener("mousemove",t=>o.mouseMove(t)),document.addEventListener("mouseup",t=>o.mouseUp(t)),e.addEventListener("touchstart",t=>c.touchStart(t)),document.addEventListener("touchend",t=>c.touchEnd(t)),document.addEventListener("touchmove",t=>c.touchMove(t)),async function(){try{await We(r,s,n),n.requestRender()}catch(t){console.error(j(t))}}()}catch(a){const e=document.body,r=j(a).message,s=document.createElement("pre");s.classList.add("error"),s.append(r),e.prepend(s)}
