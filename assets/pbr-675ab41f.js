var g=Object.defineProperty;var ee=(t,e,a)=>e in t?g(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var u=(t,e,a)=>(ee(t,typeof e!="symbol"?e+"":e,a),a);import"./modulepreload-polyfill-3cfb730f.js";/* empty css             */import{r as te,i as ae,A as re,T as se,M as ne,S as R,f as C,P as S,a as D,b as y,u as x,F as X,I as oe,N as v,c as O,d as k,e as ie,B as L,n as ce,g as de,h as ue,j as U,V as me,G as pe,k as he,C as Ee,l as H,m as B,o as fe,p as we,q as Re,s as Te,t as I,v as _e,w as Me}from"./fullscreen-quad-8f42921c.js";import{e as be,i as le,R as Ae,s as Se,a as De,p as Fe,b as ye,c as ve,d as xe,f as Le,g as Ue,h as Ie,j as ke}from"./prefiltered-env-map-20191d79.js";function Ne(t){return[parseInt(t.slice(1,3),16)/255,parseInt(t.slice(3,5),16)/255,parseInt(t.slice(5,7),16)/255]}function Ve(t){const a=Math.pow(t[0],2.2),r=Math.pow(t[1],2.2),s=Math.pow(t[2],2.2);return[a,r,s]}function Ge(t,e,a){const r=_e(Me(),e);t.setUniformValues({model:e,inverseTranspose:r,view:a.view,proj:a.proj,viewPos:a.position,viewPosition:a.position,inverseView:a.inverseView},!0)}function Be(t,e,a,r,s){Ge(s,a,r),s.use(t);for(let o=0;o<e.subMeshes.length;++o)e.draw(t,o)}class Pe{constructor(e,a,r,s){u(this,"mesh");u(this,"material");u(this,"node");this.node=a,this.mesh=r,this.material=s}draw(e,a){Be(e,this.mesh,this.node.globalMatrix,a,this.material)}}class Ce{constructor(e,a,r){u(this,"mesh");u(this,"material");this.material=r,this.mesh=a}draw(e,a){const r=B();fe(r,a.inverseView);for(let o=12;o<15;++o)r[o]=0;const s=we(B(),r,a.inverseProj);this.material.setUniformValues({inverseViewProj:s}),this.material.use(e),this.mesh.draw(e,0)}}class Xe{constructor(){u(this,"nodes");u(this,"cameras");u(this,"drawers");u(this,"materials");this.nodes=[],this.drawers=[],this.cameras=[],this.materials=[]}update(e,a){this.nodes.forEach(r=>r.preUpdate(a)),this.nodes.forEach(r=>r.update(e)),this.cameras.forEach(r=>r.update(e)),this.cameras.sort((r,s)=>r.order-s.order),this.drawers.sort((r,s)=>r.material.queue-s.material.queue)}}function Oe(t,e,a){const r=O(t,e);return new k(t,r,a)}class He{constructor(e){u(this,"gl");u(this,"scene");u(this,"inputSystem");u(this,"standardVertexModel");u(this,"quadMesh");u(this,"toneMap");u(this,"brdfLutMap");u(this,"whiteTexture");u(this,"framebuffer");u(this,"take");u(this,"callbackId");const a=new me([{name:"POSITION",location:0},{name:"NORMAL",location:1},{name:"TEXCOORD_0",location:3},{name:"TEXCOORD_1",location:4},{name:"TEXCOORD_2",location:5}]),r=H.createQuad("quad"),s=Oe(e,r,a),o=new R(e,e.VERTEX_SHADER,C),c=new R(e,e.FRAGMENT_SHADER,be),f=new S(e,"exposure",a,o,c),n=new D(e,f,{name:"toneMap"}),E=new R(e,e.FRAGMENT_SHADER,le),w=new S(e,"integrateBRDF",a,o,E),i=new D(e,w),d=new y(e,e.TEXTURE_2D,1,e.RGBA8,32,32),m=new Uint8Array(32*32*4);for(let l=0;l<m.length;++l)m[l]=255;d.bind(e).subImage2D(e.TEXTURE_2D,0,0,0,32,32,e.RGBA,e.UNSIGNED_BYTE,m).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST);const h=new Ae(e,{cube:!1,width:256,height:256,colorInternalFormat0:e.RGBA16F});x(h,e,l=>{e.viewport(0,0,h.width,h.height),e.clear(e.COLOR_BUFFER_BIT),i.use(e),s.draw(e,0)});const _=e.drawingBufferWidth,T=e.drawingBufferHeight,p=new y(e,e.TEXTURE_2D,1,e.RGBA16F,_,T);p.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const M=new y(e,e.TEXTURE_2D,1,e.DEPTH_COMPONENT32F,_,T);M.bind(e).parameteri(e.TEXTURE_MIN_FILTER,e.NEAREST).parameteri(e.TEXTURE_MAG_FILTER,e.NEAREST).parameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE).parameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE).unbind();const b=new X(e,e.FRAMEBUFFER);x(b,e,l=>{l.texture2D(e.COLOR_ATTACHMENT0,e.TEXTURE_2D,p,0).texture2D(e.DEPTH_ATTACHMENT,e.TEXTURE_2D,M,0).checkStatus(F=>{if(F!=e.FRAMEBUFFER_COMPLETE)throw new pe(e,F||e.getError())})}),n.setUniformValues({exposure:1.5,hdrBuffer:p}),this.gl=e,this.scene=new Xe,this.inputSystem=new oe,this.take=0,this.standardVertexModel=a,this.quadMesh=s,this.toneMap=n,this.framebuffer=b,this.callbackId=0,this.brdfLutMap=h.colorTextures[0],this.whiteTexture=d}requestRender(){this.callbackId===0&&(this.callbackId=requestAnimationFrame(e=>{this.scene.update(++this.take,0),this.render(),this.callbackId=0}))}render(){const e=this.gl,a=this.scene.drawers;let r=0,s=0;e.clearColor(0,0,0,1),e.clearDepth(1),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.depthFunc(e.LEQUAL);const o=[0];for(let c=1;c<=8;++c)o[c]=0;for(const c of a)o[c.material.queue]++;for(let c=1;c<=8;++c)o[c]+=o[c-1];o.unshift(0),x(this.framebuffer,e,c=>{const{width:f,height:n}=this.framebuffer.size;if(e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r=o[3],s=o[6],r<s)for(const E of this.scene.cameras){const w=E.viewport(f,n).map(Math.round),i=E.prepare(w.aspectRatio);e.viewport(w.x,w.y,w.w,w.h);for(let d=r;d<s;++d)a[d].draw(e,i)}}),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.toneMap.use(e),this.quadMesh.draw(e,0),this.inputSystem.reset()}}function A(t,e){return t.push(e),e}class je{constructor(e,a,r){u(this,"rotator");u(this,"translator");u(this,"inputSystem");this.rotator=e,this.translator=a,this.inputSystem=r}preUpdate(e,a){const s=this.rotator.trs.rotation;s[0]-=this.inputSystem.dragDelta[1]*.5,s[1]-=this.inputSystem.dragDelta[0]*.5;const o=.1,c=this.translator.trs.translation;c[2]=he(c[2]+this.inputSystem.scrollDelta*o,1,100)}}function P(t){return t instanceof Error?t:new Error(String(t))}async function ze(t,e,a){const r=a.scene,s=A(r.nodes,new v(null,"center")),o=A(r.nodes,new v(s,"camera")),c=new Re(Te.deg(45),.1,1e3);A(r.cameras,new Ee(o,0,c)),o.trs.translation[2]=3,s.trs.rotation[0]=-15,s.trs.rotation[1]=150,s.addComponent(new je(s,o,a.inputSystem));const f=O(t,H.createBackdrop("backdrop")),n=new k(t,f,a.standardVertexModel),E=new R(t,t.VERTEX_SHADER,Se),w=new R(t,t.FRAGMENT_SHADER,De),i=new S(t,"skybox",a.standardVertexModel,E,w),d=new D(t,i,{name:"ocean",queue:5});A(r.drawers,new Ce(t,n,d)),new R(t,t.VERTEX_SHADER,C);const m=new R(t,t.VERTEX_SHADER,Fe),h=new R(t,t.FRAGMENT_SHADER,ye),_=new S(t,"pbr",a.standardVertexModel,m,h),T=A(r.materials,new D(t,_,{queue:3})),p=new y(t,t.TEXTURE_CUBE_MAP,11,t.SRGB8_ALPHA8,1024,1024),M=await e.loadImageBitmapCube(["/skybox/ocean/right.jpg","/skybox/ocean/left.jpg","/skybox/ocean/top.jpg","/skybox/ocean/bottom.jpg","/skybox/ocean/front.jpg","/skybox/ocean/back.jpg"],{resizeWidth:p.width,resizeHeight:p.height,resizeQuality:"medium"});p.bind(t).subImageCube(0,0,0,t.RGBA,t.UNSIGNED_BYTE,M).parameteri(t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR).parameteri(t.TEXTURE_MAG_FILTER,t.LINEAR).generateMipmap(),M.forEach(Z=>Z.close()),d.setUniformValues({skybox:p});const b=new R(t,t.VERTEX_SHADER,ve),l=new R(t,t.FRAGMENT_SHADER,xe),F=new S(t,"irradiance",a.standardVertexModel,b,l),j=new D(t,F,{uniforms:{envMap:p}}),N=new X(t,t.FRAMEBUFFER),z=Le(t,128,j,a.quadMesh,N),W=new R(t,t.VERTEX_SHADER,Ue),$=new R(t,t.FRAGMENT_SHADER,Ie),q=new S(t,"prefiltered",a.standardVertexModel,W,$),Q=new D(t,q,{uniforms:{envMap:p}}),V=6,Y=ke(t,V,3,Q,a.quadMesh,N);T.setUniformValues({baseColorMap:a.whiteTexture,brdfLutMap:a.brdfLutMap,irradianceEnvMap:z,maxLevel:V,prefilteredEnvMap:Y});const G=A(r.nodes,new v(null,"sphere"));G.trs.translation=ie(-.2,-.8,0);const J=new URL("/Duck.gltf",window.location.toString()),K=await e.loadGltf(J.href);$e(t,a.scene,G,K,t.STATIC_DRAW,T)}function We(t){const e=2*(t[3]*t[0]+t[1]*t[2]),a=1-2*(t[0]*t[0]+t[1]*t[1]),r=I(Math.atan2(e,a)),s=Math.sqrt(1+2*(t[3]*t[1]-t[0]*t[2])),o=Math.sqrt(1-2*(t[3]*t[1]-t[0]*t[2])),c=I(2*Math.atan2(s,o)-Math.PI/2),f=2*(t[3]*t[2]+t[0]*t[1]),n=1-2*(t[1]*t[1]+t[2]*t[2]),E=I(Math.atan2(f,n));return[r,c,E]}function $e(t,e,a,r,s,o){const c=(r.bufferViews||[]).map(i=>{const d=r.buffers[i.buffer],m=new DataView(d.data,i.byteOffset||0,i.byteLength);switch(i.target){case t.ARRAY_BUFFER:case t.ELEMENT_ARRAY_BUFFER:const h=new L(t,i.target);return h.bind(t).data(m,s),h;default:return m}}),f=(r.accessors||[]).map(i=>({buffer:c[i.bufferView],size:ce(i.type),type:i.componentType,count:i.count,normalized:!!i.normalized,stride:de(r,i)||0,offset:i.byteOffset})),n=[],E=[0];for(const i of r.meshes||[]){for(const d of i.primitives){const m={};for(const p in d.attributes){const M=f[d.attributes[p]];console.assert(M.buffer instanceof L),m[p]=M}let h;d.indices!=null&&(console.assert(f[d.indices].buffer instanceof L),h=f[d.indices]);const _=d.mode??t.TRIANGLES,T={name:i.name||"",attributes:m,drawMode:_,indices:h};n.push(new k(t,T,o.program.vertexModel))}E.push(n.length)}const w=(r.nodes||[]).map(i=>A(e.nodes,new v(a,i.name??"")));for(let i=0;i<w.length;++i){const d=w[i],m=r.nodes[i];let h,_,T;m.matrix?{translation:h,rotation:_,scale:T}=ue(m.matrix):(h=m.translation||[0,0,0],_=m.rotation||[0,0,0,1],T=m.scale||[1,1,1]),U(d.trs.scale,T),U(d.trs.translation,h),U(d.trs.rotation,We(_));for(const p of m.children||[])w[p].parent=d;if(m.mesh!==void 0){const p=E[m.mesh],M=E[m.mesh+1];for(let b=p;b<M;++b)e.drawers.push(new Pe(t,d,n[b],o))}}}function qe(t){switch(t){case"range":return Number;case"color":return e=>Ve(Ne(e));default:return e=>0}}try{const t=document.querySelector("main canvas");if(!t)throw new Error("cannot find the canvas");te(t,1024);const e=ae(t),a=Array.from(document.querySelectorAll(".inspector input")),r=new re,s=new He(e),o=new se(n=>{switch(n.touchDrags.length){case 1:s.inputSystem.drag(n.touchDrags[0].delta[0],n.touchDrags[0].delta[1]);break}s.requestRender()}),c=new ne(n=>{s.inputSystem.drag(n.delta[0],n.delta[1]),s.requestRender()});t.addEventListener("mousedown",n=>c.mouseDown(n)),document.addEventListener("mousemove",n=>c.mouseMove(n)),document.addEventListener("mouseup",n=>c.mouseUp(n)),t.addEventListener("touchstart",n=>o.touchStart(n)),document.addEventListener("touchend",n=>o.touchEnd(n)),document.addEventListener("touchmove",n=>o.touchMove(n)),ze(e,r,s).then(()=>{s.requestRender()}).catch(n=>{console.error(P(n))});const f=s.scene.materials.find(n=>n.name==="pbr");for(const n of a){const E=qe(n.type);n.addEventListener("input",w=>{f.setUniformValues({[n.id]:E(n.value)}),s.requestRender()}),f.setUniformValues({[n.id]:E(n.value)})}s.requestRender()}catch(t){const e=document.body,a=P(t).message,r=document.createElement("p");r.classList.add("error"),r.append(a),e.prepend(r)}
